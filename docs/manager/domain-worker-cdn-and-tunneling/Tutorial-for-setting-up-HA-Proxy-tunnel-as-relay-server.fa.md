---
title: آموزش راه‌اندازی تانل HA-Proxy به عنوان سرور میانی
---

# آموزش راه‌اندازی تانل HA-Proxy به عنوان سرور میانی

## آموزش استفاده از تانل HA-Proxy و اتصال آن به هیدیفای‌منیجر
برای این کار شما به یک سرور میانی نیاز دارید تا از طریق آن به سرور اصلی متصل شوید. معمولا این سرور میانی در کشور محل اقامت در نظر گرفته می‌شود.

<img src="https://user-images.githubusercontent.com/125398461/235339506-bdd76cec-0378-4942-8352-ebebeb006231.png">

حالا در اینجا برای ارتباط بین سرور میانی و سرور اصلی از تانل HA-proxy استفاده می‌شود. بعد از نصب شما به سرور میانی متصل می‌شوید، آن سرور شما را به سرور اصلی متصل می‌کند و سپس از سرور اصلی به اینترنت آزاد دسترسی خواهید داشت.

> نکته: ما این اسکریپت‌ها را روی ابونتو ۲۲.۰۴ تست کردیم بنابراین بهتر هست از این نسخه استفاده کنید.

## نصب تانل HA-Proxy بروی سرور میانی و اتصال آن به سرور خارج

- برای این کار شما به یک سرور میانی نیاز دارید تا از طریق آن به سرور اصلی متصل شوید. معمولا این سرور میانی در کشور محل اقامت در نظر گرفته می‌شود.

- به سرور میانی [SSH بزنید](https://github.com/hiddify/Hiddify-Manager/wiki/SSH-%D8%A2%D9%85%D9%88%D8%B2%D8%B4-%D8%A7%D8%AA%D8%B5%D8%A7%D9%84-%D8%A8%D9%87-%D8%B3%D8%B1%D9%88%D8%B1-%D8%A7%D8%B2-%D8%B7%D8%B1%DB%8C%D9%82) و دستور نصب HA-proxy را اجرا کنید‌.

```bash
sudo apt-get install haproxy
```

- پس از نصب باید فایل `haproxy.cfg` را تغییر دهید ، دستور زیرا بزنید تا فایل `haproxy.cfg`  با ویرایشگر متنی `nano` باز شود.

```bash
nano /etc/haproxy/haproxy.cfg
```

- پس باز شدن فایل `haproxy.cfg` به انتهای فایل بروید و مثال زیر را اضافه کنید:

```bash
frontend myfrontend
    bind *:RELAY_PORT
    mode tcp
    default_backend mybackend

backend mybackend
    mode tcp
    server target_server MAIN_SERVER_IP:MAIN_SERVER_PORT
```

- در قسمت `RELAY_PORT` پورت سرور میانی خود را قرار دهید که برای ارسال درخواست به سرور اصلی در نظر گرفتید.

- در قسمت MAIN_SERVER_IP:MAIN_SERVER_PORT بایستی آیپی و پورت سرور اصلی خود را قرار دهید. به طور مثال پورت ۴۴۳ توسط هیدیفای به صورت دیفالت استفاده می‌شود.

- به طور مثال اگر فرضا آیپی سرور اصلی شما `10.10.10.10` باشد، در این حالت برای انتقال ترافیک کاربران روی پورت `443` از طریق سرور میانی به سرور اصلی، فایل مورد نظر باید به شکل زیر باشد:

```bash
frontend myfrontend
    bind *:443
    mode tcp
    default_backend mybackend

backend mybackend
    mode tcp
    server target_server 10.10.10.10:443
```

- پس از انجام تغییرات با زدن دکمه‌های `Ctrl + s`  تغییرات را ذخیره کنید و با زدن `Ctrl + x` از فایل خارج شوید. 

- پس از ذخیره فایل، دستور ریستارت HAProxy را بزنید.

```bash
sudo systemctl restart haproxy
```
## تعریف سرور میانی در هیدیفای
حالا برای آیپی سرور میانی خود یک ساب‌دامین با پروکسی خاموش ثبت نمایید و آن را در هیدیفای روی حالت Relay ثبت نمایید.

<img src="https://user-images.githubusercontent.com/125398461/235341283-97c026b7-1d70-4362-8950-1e5c1b79d508.png">

## افزودن کانفیگ‌های Relay جهت استفاده به لینک سابسکریپشن

همانند همیشه در هیدیفای بهتر است کانفیگ‌ها را از لینک سابسکریپشن جدا کنید. بنابراین برای دامنه Relay ثبت شده نیز می‌توانید در تنظیمات دامنه مربوط به سابسکریپشن، تیک مربوط به دامین Relay را بزنید تا کانفیگ‌های آن به دامنه سابسکریپشن اضافه گردند.

فرض شود که دامنه مربوط به سابسکریپشن `t1.hiddify.com` باشد، مطابق با تصویر زیر جلو بروید تا کار انجام شود.
<img src="https://user-images.githubusercontent.com/125398461/235342038-cfda2574-2444-4414-843d-2ed507537d1d.png">

حالا اگه صفحه کاربر را با دامین سابسکریپشن (در اینجا `t1.hiddify.com`) باز نمایید خواهید دید که کانکشن‌های مربوط به Relay نیز اضافه شده‌اند. می‌توانید این کانکشن‌ها را به صورت تک تک و یا با استفاده از لینک‌های سابسکریشن معمولی یا سابسکریپشن b64 به کلاینت خود اضافه نمایید و استفاده نمایید.

## حذف تانل HA-Proxy از سرور میانی

برای این کار ابتدا این دستور را اجرا کنید.
```bash
sudo systemctl stop haproxy && systemctl disable haproxy
````
در نهایت برای حذف کامل برنامه و سرویس این دستور را بزنید.

```bash
sudo apt remove haproxy
```
